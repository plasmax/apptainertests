Bootstrap: docker
From: ubuntu:22.04

%labels
    Description Minimal test build for ppisp CUDA extension

%post
    set -ex

    export DEBIAN_FRONTEND=noninteractive

    # Minimal system dependencies
    apt-get update
    apt-get install -y --no-install-recommends \
        python3.10 python3-pip python3.10-dev \
        ca-certificates wget git build-essential ninja-build

    # CUDA 12.4 toolkit
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
    dpkg -i cuda-keyring_1.1-1_all.deb
    rm cuda-keyring_1.1-1_all.deb
    apt-get update
    apt-get install -y --no-install-recommends cuda-toolkit-12-4

    # Set CUDA paths
    export PATH="/usr/local/cuda-12.4/bin:${PATH}"
    export LD_LIBRARY_PATH="/usr/local/cuda-12.4/lib64:${LD_LIBRARY_PATH}"
    export CUDA_HOME="/usr/local/cuda-12.4"
    ln -sf /usr/local/cuda-12.4 /usr/local/cuda

    # CUDA architectures for CI (no GPU available)
    export TORCH_CUDA_ARCH_LIST="7.5;8.0;8.6;8.9;9.0"

    # Install pip tools
    pip install -U pip uv

    # Install PyTorch with CUDA 12.4
    uv pip install --system \
        "torch @ https://download.pytorch.org/whl/cu124/torch-2.4.0%2Bcu124-cp310-cp310-linux_x86_64.whl"

    # Clone ppisp and inspect/patch it
    git clone --depth 1 --branch v1.0.0 https://github.com/nv-tlabs/ppisp.git /tmp/ppisp

    echo "=== Original setup.py ==="
    cat /tmp/ppisp/setup.py

    echo "=== Patching setup.py ==="
    # Remove the unsupported compute_120 line
    sed -i '/compute_120/d' /tmp/ppisp/setup.py

    echo "=== Patched setup.py ==="
    cat /tmp/ppisp/setup.py

    echo "=== pyproject.toml ==="
    cat /tmp/ppisp/pyproject.toml || echo "No pyproject.toml"

    echo "=== Installing ppisp ==="
    # Try with pip instead of uv to see if it handles metadata differently
    MAX_JOBS=2 pip install --no-build-isolation /tmp/ppisp

    rm -rf /tmp/ppisp

%test
    python3 -c "import ppisp_cuda; print('ppisp OK')"
