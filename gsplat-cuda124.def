Bootstrap: docker
From: ubuntu:22.04

%labels
    Description gsplat (Gaussian Splatting) with CUDA 12.4 on Ubuntu 22.04 (glibc 2.34)

%environment
    export PATH="/usr/local/cuda/bin:${PATH}"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:${LD_LIBRARY_PATH}"
    export PYTHONUNBUFFERED=1
    export PYTHONNOUSERSITE=1

%post
    set -e

    export DEBIAN_FRONTEND=noninteractive

    # Install system dependencies
    apt-get update
    apt-get install -y --no-install-recommends \
        python3.10 python3-pip python3.10-dev \
        ca-certificates curl wget gnupg \
        git build-essential ninja-build \
        libglib2.0-0 libgl1-mesa-glx libsm6 libxext6 libxrender1 \
        libglm-dev \
        ffmpeg \
        && rm -rf /var/lib/apt/lists/*

    # Add NVIDIA CUDA repository for Ubuntu 22.04
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
    dpkg -i cuda-keyring_1.1-1_all.deb
    rm cuda-keyring_1.1-1_all.deb
    apt-get update

    # Install CUDA toolkit 12.4 (no driver needed inside container; use --nv at runtime)
    apt-get install -y --no-install-recommends \
        cuda-toolkit-12-4 \
        && rm -rf /var/lib/apt/lists/*

    # Set CUDA paths for the build
    export PATH="/usr/local/cuda-12.4/bin:${PATH}"
    export LD_LIBRARY_PATH="/usr/local/cuda-12.4/lib64:${LD_LIBRARY_PATH}"
    export CUDA_HOME="/usr/local/cuda-12.4"

    # Symlink cuda to the installed version
    ln -sf /usr/local/cuda-12.4 /usr/local/cuda

    # Set CUDA architectures for compilation (required for CI builds without GPU)
    # Covers: Volta (V100), Turing (RTX 20xx, T4), Ampere (RTX 30xx, A100, A10),
    # Ada Lovelace (RTX 40xx, L4, L40), Hopper (H100)
    export TORCH_CUDA_ARCH_LIST="7.0;7.5;8.0;8.6;8.9;9.0"

    # Upgrade pip and install uv
    pip install -U pip uv

    # Write the requirements file directly inside the container
    # Note: CUDA extension packages are installed separately with --no-build-isolation
    cat > /tmp/requirements_gsplat.txt <<'EOF'
# gsplat core dependencies
numpy<2.0.0
ninja
jaxtyping
rich>=12

# examples dependencies (from examples/requirements.txt)
# pycolmap for data parsing
git+https://github.com/rmbrualla/pycolmap@cc7ea4b7301720ac29287dbe450952511b32125e
# viser for visualization
viser
git+https://github.com/nerfstudio-project/nerfview@4538024fe0d15fd1a0e4d760f3695fc44ca72787
imageio[ffmpeg]
scikit-learn
tqdm
torchmetrics[image]
opencv-python-headless
tyro>=0.8.8
Pillow
piexif
tensorboard
tensorly
pyyaml
matplotlib
splines
EOF

    # Install PyTorch with CUDA 12.4 first (required for all CUDA extension builds)
    uv pip install --system \
        "torch @ https://download.pytorch.org/whl/cu124/torch-2.4.0%2Bcu124-cp310-cp310-linux_x86_64.whl" \
        "torchvision @ https://download.pytorch.org/whl/cu124/torchvision-0.19.0%2Bcu124-cp310-cp310-linux_x86_64.whl"

    # Install gsplat from source (builds CUDA extensions)
    # --no-build-isolation is required so setup.py can find torch
    MAX_JOBS=4 uv pip install --system --no-build-isolation \
        git+https://github.com/nerfstudio-project/gsplat.git

    # Install other CUDA extension packages (also need --no-build-isolation)
    # Install one at a time to isolate any failures and reduce memory pressure
    MAX_JOBS=2 uv pip install --system --no-build-isolation \
        "git+https://github.com/rahul-goel/fused-ssim@328dc9836f513d00c4b5bc38fe30478b4435cbb5"

    MAX_JOBS=2 uv pip install --system --no-build-isolation \
        "git+https://github.com/harry7557558/fused-bilagrid@49f0ef06c9f81810fb9b5dd9027cf1844950cc16"

    # ppisp uses torch.cuda.is_available() which is False in CI, falling back to
    # its own architecture list which includes compute_120 (Blackwell) - not supported by CUDA 12.4
    # Clone, patch setup.py to remove unsupported architecture, then install
    # Use pip instead of uv - uv has issues parsing ppisp's metadata
    git clone --depth 1 --branch v1.0.0 https://github.com/nv-tlabs/ppisp.git /tmp/ppisp
    sed -i '/compute_120/d' /tmp/ppisp/setup.py
    MAX_JOBS=2 pip install --no-build-isolation /tmp/ppisp
    rm -rf /tmp/ppisp

    # Install remaining dependencies from requirements
    uv pip install --system -r /tmp/requirements_gsplat.txt

    # Clean up
    rm /tmp/requirements_gsplat.txt
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%test
    set -e
    # Verify CUDA toolkit
    nvcc --version
    # Verify PyTorch and CUDA availability
    python3 -c "import torch; print(f'Torch Version: {torch.__version__}'); print(f'CUDA Available: {torch.cuda.is_available()}'); print(f'CUDA Version: {torch.version.cuda}')"
    # Verify gsplat import and CUDA extension is built
    python3 -c "import gsplat; from gsplat import csrc; print(f'gsplat {gsplat.__version__} with CUDA extension loaded successfully')"
