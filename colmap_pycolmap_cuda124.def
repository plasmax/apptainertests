Bootstrap: docker
From: rockylinux:9

%labels
    Description COLMAP + pycolmap (CUDA 12.4) on Rocky 9 (glibc 2.34), CLI-only

%environment
    export PATH="/opt/colmap/bin:${PATH}"
    export LD_LIBRARY_PATH="/opt/colmap/lib64:/opt/colmap/lib:${LD_LIBRARY_PATH}"
    export PYTHONNOUSERSITE=1

%post
    set -euo pipefail

    dnf -y update

    # Core tooling first (needed to enable repos cleanly)
    dnf -y install dnf-plugins-core ca-certificates git which file \
                   gcc gcc-c++ make pkgconf-pkg-config \
                   python3 python3-pip python3-devel \
                   curl wget

    # Enable CRB + EPEL BEFORE trying to install anything that might live there
    dnf config-manager --set-enabled crb || true
    dnf -y install epel-release
    dnf -y update

    # CMake in Rocky can be old depending on stream; prefer cmake if present, else fall back to cmake3.
    if ! dnf -y install cmake; then
        dnf -y install cmake3
        ln -sf /usr/bin/cmake3 /usr/local/bin/cmake
    fi

    # ---- CUDA 12.4 toolkit (no driver in container; you use --nv at runtime)
    dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo
    dnf -y clean all
    dnf -y install cuda-toolkit-12-4

    # ---- COLMAP deps (CLI-only build: no Qt/GUI, no CGAL, no OpenGL)
    # Many of these are in EPEL/CRB.
    dnf -y install \
        boost-devel \
        eigen3-devel \
        freeimage-devel \
        metis-devel \
        glog-devel \
        gflags-devel \
        sqlite-devel \
        curl-devel \
        openssl-devel \
        libtiff-devel \
        libjpeg-turbo-devel \
        libpng-devel \
        libstdc++-devel \
        suitesparse-devel \
        lapack-devel \
        blas-devel

    # ---- Ceres: try system package, else build from source
    if ! dnf -y install ceres-solver-devel; then
        echo "ceres-solver-devel not available; building Ceres from source..."
        git clone --depth 1 https://github.com/ceres-solver/ceres-solver.git /tmp/ceres
        cmake -S /tmp/ceres -B /tmp/ceres/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_INSTALL_PREFIX=/usr/local
        cmake --build /tmp/ceres/build -j"$(nproc)"
        cmake --install /tmp/ceres/build
        rm -rf /tmp/ceres
    fi

    # ---- Python build tooling for pycolmap (important on EL9)
    python3 -m pip install --upgrade pip setuptools wheel
    python3 -m pip install --upgrade scikit-build-core pybind11 cmake ninja || true
    # (We don't *need* ninja, but installing it via pip sometimes helps other builds; it's optional.)

    # ---- Build COLMAP
    git clone --depth 1 https://github.com/colmap/colmap.git /tmp/colmap

    cmake -S /tmp/colmap -B /tmp/colmap/build \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/opt/colmap \
        -DCUDA_ENABLED=ON \
        -DCMAKE_CUDA_ARCHITECTURES=86 \
        -DGUI_ENABLED=OFF \
        -DOPENGL_ENABLED=OFF \
        -DCGAL_ENABLED=OFF \
        -DTESTS_ENABLED=OFF \
        -DCMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY

    cmake --build /tmp/colmap/build -j"$(nproc)"
    cmake --install /tmp/colmap/build

    # ---- Build/install pycolmap from the COLMAP repo
    # Point pycolmap at the COLMAP we just installed.
    export CMAKE_PREFIX_PATH="/opt/colmap:${CMAKE_PREFIX_PATH:-}"
    python3 -m pip install /tmp/colmap/pycolmap

    # Cleanup
    rm -rf /tmp/colmap
    dnf -y clean all
    rm -rf /var/cache/dnf

%test
    set -e
    /opt/colmap/bin/colmap -h >/dev/null
    python3 -c "import pycolmap; print('pycolmap OK', pycolmap.__version__)"